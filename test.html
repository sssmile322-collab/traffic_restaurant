<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>å¿«é©é£Ÿå ‚ | Smart Restaurant</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb">
  <link rel="apple-touch-icon" href="icon.png">

  <meta property="og:title" content="å¿«é©é£Ÿå ‚ | Smart Restaurant" />
  <meta property="og:description" content="å­¦é£Ÿã®æ··é›‘çŠ¶æ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¢ºèªï¼ç©ºã„ã¦ã„ã‚‹æ™‚é–“ã‚’ç‹™ã£ã¦è¡Œã“ã†ã€‚" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://traffic-restaurant.web.app/" />
  <meta property="og:image" content="https://traffic-restaurant.web.app/icon.png" />
  <meta name="twitter:card" content="summary" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <style>
    :root {
      --primary: #2563eb; --bg: #f8fafc; --surface: #ffffff; --surface-sub: #f1f5f9;
      --text: #1e293b; --text-sub: #64748b; --border: #e2e8f0;
      --accent-free: #10b981; --accent-busy: #ef4444;
      --card-shadow: 0 10px 40px -10px rgba(0,0,0,0.08); --fab-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    body.dark-mode {
      --primary: #60a5fa; --bg: #0f172a; --surface: #1e293b; --surface-sub: #334155;
      --text: #f1f5f9; --text-sub: #94a3b8; --border: #334155;
      --accent-free: #34d399; --accent-busy: #f87171;
      --card-shadow: 0 10px 40px -10px rgba(0,0,0,0.5); --fab-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: var(--bg); color: var(--text); -webkit-tap-highlight-color: transparent; padding-bottom: 100px; overscroll-behavior: none; transition: background-color 0.3s, color 0.3s; }
    canvas { touch-action: none; }
    .container { max-width: 480px; margin: 0 auto; padding: 20px; display: flex; flex-direction: column; gap: 24px; }

    header { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
    .brand { display: flex; align-items: center; gap: 10px; }
    .brand-icon { font-size: 2rem; color: var(--primary); }
    .brand-text { display: flex; flex-direction: column; line-height: 1.1; }
    .brand-main { font-size: 1.25rem; font-weight: 800; color: var(--text); }
    .brand-sub { font-size: 0.75rem; font-weight: 600; color: var(--text-sub); letter-spacing: 0.02em; }
    .header-controls { display: flex; align-items: center; gap: 12px; }
    .theme-toggle-btn { background: none; border: none; color: var(--text-sub); cursor: pointer; padding: 4px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s, color 0.2s; }
    .theme-toggle-btn:active { background: var(--surface-sub); }
    .theme-toggle-btn .material-icons-round { font-size: 1.5rem; }
    
    .live-badge { font-size: 0.7rem; padding: 6px 10px; border-radius: 99px; font-weight: 700; display: flex; align-items: center; gap: 6px; transition: all 0.3s ease; }
    .live-badge.online { background: rgba(239, 68, 68, 0.15); color: var(--accent-busy); }
    .live-badge.offline { background: var(--surface-sub); color: var(--text-sub); }
    .live-dot { width: 6px; height: 6px; background: currentColor; border-radius: 50%; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% {opacity: 1;} 50% {opacity: 0.4;} 100% {opacity: 1;} }

    .status-card { background: var(--surface); border-radius: 24px; padding: 32px 24px; text-align: center; box-shadow: var(--card-shadow); transition: all 0.3s ease; border: 1px solid transparent; }
    .status-text { font-size: 2rem; font-weight: 800; margin-bottom: 8px; letter-spacing: -0.02em; }
    .status-sub { color: var(--text-sub); font-size: 0.9rem; font-weight: 600; min-height: 1.4em; }
    .status-card.busy .status-text { color: var(--accent-busy); }
    .status-card.free .status-text { color: var(--accent-free); }
    .status-card.closed { background: var(--surface-sub); box-shadow: none; border: 1px solid var(--border); }
    .status-card.closed .status-text { color: var(--text-sub); }
    .status-card.closed .metric-val { color: var(--text-sub); opacity: 0.5; }
    .status-card.closed .person-icon { color: var(--border) !important; }

    .visual-queue { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin: 24px 0; min-height: 40px; }
    .person-icon { font-family: 'Material Icons Round'; font-size: 32px; color: var(--text-sub); opacity: 0; transform: scale(0.5); animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    .person-icon.active { color: var(--primary); }
    @keyframes popIn { to { opacity: 1; transform: scale(1); } }

    .metrics { display: flex; justify-content: space-around; margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border); }
    .metric-item { display: flex; flex-direction: column; gap: 4px; }
    .metric-val { font-size: 1.4rem; font-weight: 800; }
    .metric-label { font-size: 0.75rem; color: var(--text-sub); font-weight: 600; }
    .last-update { margin-top: 16px; font-size: 0.7rem; color: var(--text-sub); text-align: right; opacity: 0.8; }

    .graph-section { background: var(--surface); border-radius: 20px; padding: 20px; box-shadow: var(--card-shadow); }
    .graph-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .section-title { font-size: 0.9rem; font-weight: 700; margin: 0; color: var(--text-sub); }
    .day-select { background: var(--bg); border: 1px solid var(--border); padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; color: var(--text); font-weight: 600; cursor: pointer; outline: none; }
    .chart-container { position: relative; height: 180px; width: 100%; }
    .no-data-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--surface); opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 10; }
    .no-data-overlay.visible { opacity: 1; pointer-events: auto; }
    .no-data-text { color: var(--text-sub); font-size: 0.85rem; font-weight: 600; margin-top: 8px; }
    .no-data-icon { font-size: 48px; color: var(--border); }

    .fab-btn { position: fixed; right: 24px; background: var(--text); color: var(--bg); border-radius: 99px; font-weight: 700; box-shadow: var(--fab-shadow); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100; transition: transform 0.2s; }
    .fab-btn:active { transform: scale(0.95); }
    
    /* FABã®ä½ç½®èª¿æ•´ */
    .share-fab { bottom: 90px; width: 56px; height: 56px; border-radius: 50%; }
    .share-fab .material-icons-round { font-size: 24px; }
    
    /* â–¼â–¼â–¼ ä¿®æ­£: è‰²æŒ‡å®šã‚’å‰Šé™¤ã—ã€å…±é€šã‚¹ã‚¿ã‚¤ãƒ«ã®é…è‰²ã‚’ä½¿ç”¨ â–¼â–¼â–¼ */
    .feedback-fab { bottom: 156px; width: 56px; height: 56px; border-radius: 50%; }
    .feedback-fab .material-icons-round { font-size: 24px; }

    .menu-fab { bottom: 24px; padding: 16px 24px; gap: 8px; }

    .overlay-base { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s; display: flex; }
    .overlay-base.open { opacity: 1; pointer-events: auto; }
    #menuModal, #feedbackModal { justify-content: center; align-items: flex-end; }
    .menu-sheet { background: var(--bg); width: 100%; max-width: 500px; height: 85vh; border-radius: 24px 24px 0 0; padding: 24px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; border-top: 1px solid var(--border); }
    #menuModal.open .menu-sheet, #feedbackModal.open .menu-sheet { transform: translateY(0); }
    
    /* ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 700; margin-bottom: 8px; color: var(--text-sub); }
    .form-select, .form-textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: var(--surface); color: var(--text); font-family: inherit; font-size: 1rem; resize: none; outline: none; transition: border-color 0.2s; }
    .form-select:focus, .form-textarea:focus { border-color: var(--primary); }
    .form-textarea { height: 120px; }
    .submit-btn { width: 100%; padding: 16px; background: var(--text); color: var(--bg); border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .close-btn { background: var(--surface-sub); color: var(--text); border: none; width: 36px; height: 36px; border-radius: 50%; display: grid; place-items: center; cursor: pointer; }
    .menu-viewer { flex: 1; background: var(--surface); border-radius: 16px; overflow-y: auto; padding: 10px; display: flex; justify-content: center; align-items: start; }
    .menu-viewer img { width: 100%; height: auto; display: block; }
    #notifyModal { justify-content: center; align-items: center; }
    .notify-dialog { background: var(--surface); width: 85%; max-width: 320px; padding: 24px; border-radius: 20px; text-align: center; box-shadow: var(--card-shadow); }
    .notify-dialog h2 { margin: 0 0 12px; font-size: 1.1rem; }
    .notify-dialog p { font-size: 0.9rem; color: var(--text-sub); margin-bottom: 20px; line-height: 1.5; }
    .btn-group { display: flex; gap: 12px; }
    .btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-weight: 700; font-size: 0.9rem; cursor: pointer; }
    .btn-primary { background: var(--text); color: var(--bg); }
    .btn-secondary { background: var(--surface-sub); color: var(--text); }
    .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150%); background: var(--surface); padding: 16px 24px; border-radius: 16px; box-shadow: var(--card-shadow); display: flex; align-items: center; gap: 12px; z-index: 1000; transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1); min-width: 280px; border: 1px solid var(--border); }
    .toast.show { transform: translateX(-50%) translateY(0); }
    .toast-icon { font-size: 1.5rem; }
    .toast-content div:first-child { font-weight: 700; font-size: 0.9rem; color: var(--text); }
    .toast-content div:last-child { font-size: 0.8rem; color: var(--text-sub); }
  </style>
</head>
<body>

  <div id="pseudoNotify" class="toast">
    <div class="toast-icon">âœ¨</div>
    <div class="toast-content">
      <div>ç©ºã„ã¦ãã¾ã—ãŸï¼</div>
      <div>ä»ŠãŒãƒãƒ£ãƒ³ã‚¹ã§ã™</div>
    </div>
  </div>

  <div id="notifyModal" class="overlay-base">
    <div class="notify-dialog">
      <h2>é€šçŸ¥ã‚’ã‚ªãƒ³ã«ã—ã¾ã™ã‹ï¼Ÿ</h2>
      <p>è¡Œåˆ—ãŒè§£æ¶ˆã•ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§<br>ãŠçŸ¥ã‚‰ã›ã‚’å—ã‘å–ã‚Œã¾ã™ã€‚</p>
      <div class="btn-group">
        <button class="btn btn-secondary" id="notifyNo">ã‚ã¨ã§</button>
        <button class="btn btn-primary" id="notifyYes">è¨±å¯ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <div class="container">
    <header>
      <div class="brand">
        <span class="material-icons-round brand-icon">restaurant_menu</span>
        <div class="brand-text">
          <span class="brand-main">å¿«é©é£Ÿå ‚</span>
          <span class="brand-sub">Smart Restaurant</span>
        </div>
      </div>
      <div class="header-controls">
        <button id="themeToggle" class="theme-toggle-btn">
          <span class="material-icons-round">dark_mode</span>
        </button>
        <div id="liveBadge" class="live-badge offline">
          <span class="material-icons-round" style="font-size: 1rem;">cloud_off</span> OFFLINE
        </div>
      </div>
    </header>

    <div id="mainCard" class="status-card">
      <div id="statusText" class="status-text">èª­ã¿è¾¼ã¿ä¸­...</div>
      <div id="waitMessage" class="status-sub">å°‘ã€…ãŠå¾…ã¡ãã ã•ã„</div>

      <div id="visualQueue" class="visual-queue"></div>

      <div class="metrics">
        <div class="metric-item">
          <span class="metric-val"><span id="count">--</span><span style="font-size:0.9rem">äºº</span></span>
          <span class="metric-label">ç¾åœ¨ã®è¡Œåˆ—</span>
        </div>
        <div class="metric-item">
          <span class="metric-val">~<span id="waitTime">--</span><span style="font-size:0.9rem">åˆ†</span></span>
          <span class="metric-label">æ¨å®šå¾…ã¡æ™‚é–“</span>
        </div>
      </div>

      <div id="lastUpdateText" class="last-update">æœ€çµ‚æ›´æ–°: --/-- --:--</div>
    </div>

    <div class="graph-section">
      <div class="graph-header">
        <h2 class="section-title">æ··é›‘ãƒˆãƒ¬ãƒ³ãƒ‰ (13:00-18:00)</h2>
        <select id="daySelector" class="day-select">
          <option value="0">æ—¥æ›œæ—¥</option>
          <option value="1">æœˆæ›œæ—¥</option>
          <option value="2">ç«æ›œæ—¥</option>
          <option value="3">æ°´æ›œæ—¥</option>
          <option value="4">æœ¨æ›œæ—¥</option>
          <option value="5">é‡‘æ›œæ—¥</option>
          <option value="6">åœŸæ›œæ—¥</option>
        </select>
      </div>
      
      <div class="chart-container">
        <canvas id="lunchChart"></canvas>
        <div id="noDataOverlay" class="no-data-overlay">
          <span class="material-icons-round no-data-icon">show_chart</span>
          <div class="no-data-text">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      </div>
    </div>
  </div>

  <div class="feedback-fab fab-btn" id="feedbackBtn">
    <span class="material-icons-round">chat_bubble_outline</span>
  </div>

  <div class="share-fab fab-btn" id="shareBtn">
    <span class="material-icons-round">share</span>
  </div>

  <div class="menu-fab fab-btn" id="menuBtn">
    <span class="material-icons-round">menu_book</span>
    æœ¬æ—¥ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼
  </div>

  <div class="overlay-base" id="feedbackModal">
    <div class="menu-sheet" style="height: auto; max-height: 85vh;">
      <div class="modal-header">
        <h2 style="margin:0; font-size:1.1rem;">ã”æ„è¦‹ãƒ»ã”è¦æœ›</h2>
        <button class="close-btn" id="closeFeedback">
          <span class="material-icons-round">close</span>
        </button>
      </div>
      <div style="padding-bottom: 20px;">
        <div class="form-group">
          <label class="form-label">ç¨®é¡</label>
          <select id="fbCategory" class="form-select">
            <option value="food">ğŸ½ é£Ÿäº‹ã«ã¤ã„ã¦ï¼ˆå‘³ãƒ»é‡ãªã©ï¼‰</option>
            <option value="app">ğŸ“± ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦ï¼ˆå¿«é©é£Ÿå ‚ï¼‰</option>
            <option value="other">ğŸ’¬ ãã®ä»–</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">å†…å®¹</label>
          <textarea id="fbMessage" class="form-textarea" placeholder="ã”è‡ªç”±ã«ãŠæ›¸ããã ã•ã„..."></textarea>
        </div>
        <button id="fbSubmit" class="submit-btn">
          é€ä¿¡ã™ã‚‹ <span class="material-icons-round">send</span>
        </button>
      </div>
    </div>
  </div>

  <div class="overlay-base" id="menuModal">
    <div class="menu-sheet">
      <div class="modal-header">
        <h2 style="margin:0; font-size:1.1rem;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨</h2>
        <button class="close-btn" id="closeMenu">
          <span class="material-icons-round">close</span>
        </button>
      </div>
      <div class="menu-viewer">
        <img src="menu_img.png" alt="æœ¬æ—¥ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼" onerror="this.style.display='none';this.parentElement.innerHTML='<p style=\'text-align:center;color:#888;margin-top:20px\'>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>'" />
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    /* ========= è¨­å®š ========= */
    const firebaseConfig = {
      databaseURL: "https://traffic-restaurant-default-rtdb.firebaseio.com/"
    };
    const MINUTES_PER_PERSON = 2;
    const isIphone = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const OPEN_HOUR = 8; 
    const CLOSE_HOUR = 20;
    const DATA_TIMEOUT_MINUTES = 10; 

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* ========= DOM ========= */
    const countEl = document.getElementById("count");
    const waitTimeEl = document.getElementById("waitTime");
    const statusTextEl = document.getElementById("statusText");
    const waitMessageEl = document.getElementById("waitMessage");
    const visualQueueEl = document.getElementById("visualQueue");
    const mainCard = document.getElementById("mainCard");
    const daySelector = document.getElementById("daySelector");
    const liveBadgeEl = document.getElementById("liveBadge");
    const lastUpdateTextEl = document.getElementById("lastUpdateText");
    const themeToggle = document.getElementById("themeToggle");
    const noDataOverlay = document.getElementById("noDataOverlay");
    daySelector.value = new Date().getDay();
    const menuBtn = document.getElementById("menuBtn");
    const menuModal = document.getElementById("menuModal");
    const closeMenu = document.getElementById("closeMenu");
    const notifyModal = document.getElementById("notifyModal");
    const notifyYes = document.getElementById("notifyYes");
    const notifyNo = document.getElementById("notifyNo");
    const pseudoNotify = document.getElementById("pseudoNotify");
    const shareBtn = document.getElementById("shareBtn");

    // â–¼â–¼â–¼ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç”¨DOM â–¼â–¼â–¼
    const feedbackBtn = document.getElementById("feedbackBtn");
    const feedbackModal = document.getElementById("feedbackModal");
    const closeFeedback = document.getElementById("closeFeedback");
    const fbSubmit = document.getElementById("fbSubmit");
    const fbCategory = document.getElementById("fbCategory");
    const fbMessage = document.getElementById("fbMessage");

    /* ========= ãƒ†ãƒ¼ãƒ ========= */
    const themeIcon = themeToggle.querySelector(".material-icons-round");
    const savedTheme = localStorage.getItem("theme");
    const systemDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    if (savedTheme === "dark" || (!savedTheme && systemDark)) {
      document.body.classList.add("dark-mode");
      themeIcon.textContent = "light_mode";
    } else {
      document.body.classList.remove("dark-mode");
      themeIcon.textContent = "dark_mode";
    }
    themeToggle.onclick = () => {
      document.body.classList.toggle("dark-mode");
      const isDark = document.body.classList.contains("dark-mode");
      themeIcon.textContent = isDark ? "light_mode" : "dark_mode";
      localStorage.setItem("theme", isDark ? "dark" : "light");
      if(chart) {
        chart.options.scales.x.ticks.color = getComputedStyle(document.body).getPropertyValue('--text-sub').trim();
        chart.update();
      }
    };

    /* ========= ã‚¤ãƒ™ãƒ³ãƒˆ ========= */
    menuBtn.onclick = () => menuModal.classList.add("open");
    closeMenu.onclick = () => menuModal.classList.remove("open");
    menuModal.onclick = (e) => { if(e.target === menuModal) menuModal.classList.remove("open"); };

    // â–¼â–¼â–¼ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ©Ÿèƒ½ã®ã‚¤ãƒ™ãƒ³ãƒˆ â–¼â–¼â–¼
    feedbackBtn.onclick = () => feedbackModal.classList.add("open");
    closeFeedback.onclick = () => feedbackModal.classList.remove("open");
    feedbackModal.onclick = (e) => { if(e.target === feedbackModal) feedbackModal.classList.remove("open"); };

    fbSubmit.onclick = async () => {
      const msg = fbMessage.value.trim();
      if (!msg) {
        alert("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }
      
      fbSubmit.disabled = true;
      fbSubmit.textContent = "é€ä¿¡ä¸­...";

      try {
        await push(ref(db, "feedbacks"), {
          category: fbCategory.value,
          message: msg,
          timestamp: Date.now(),
          userAgent: navigator.userAgent
        });
        
        alert("ã”æ„è¦‹ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼é€ä¿¡ã—ã¾ã—ãŸã€‚");
        fbMessage.value = "";
        feedbackModal.classList.remove("open");
      } catch (e) {
        console.error(e);
        alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
      } finally {
        fbSubmit.disabled = false;
        fbSubmit.innerHTML = 'é€ä¿¡ã™ã‚‹ <span class="material-icons-round">send</span>';
      }
    };

    if (!isIphone && "Notification" in window) {
      if (Notification.permission === "default") { setTimeout(() => { notifyModal.classList.add("open"); }, 1000); }
      notifyYes.onclick = async () => { await Notification.requestPermission(); notifyModal.classList.remove("open"); };
      notifyNo.onclick = () => { notifyModal.classList.remove("open"); };
    }
    shareBtn.onclick = async () => {
      let shareText = "";
      if (mainCard.classList.contains("closed") || statusTextEl.textContent === "ãƒ‡ãƒ¼ã‚¿å—ä¿¡å¾…ã¡") {
         shareText = "å­¦é£Ÿã®æ··é›‘çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã‚ˆã†ï¼\n";
      } else {
         shareText = `ç¾åœ¨ã®æ··é›‘çŠ¶æ³: ${countEl.textContent}äººå¾…ã¡ (${statusTextEl.textContent})\n`;
      }
      const shareData = { title: 'å¿«é©é£Ÿå ‚', text: shareText, url: window.location.href };
      if (navigator.share) { try { await navigator.share(shareData); } catch (err) {} } 
      else { alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼å‹é”ã«å…±æœ‰ã—ã‚ˆã†ï¼"); navigator.clipboard.writeText(window.location.href); }
    };

    /* ========= ãƒ­ã‚¸ãƒƒã‚¯ ========= */
    function isBusinessOpen() {
      const now = new Date();
      const day = now.getDay();
      const h = now.getHours();
      if (day === 0 || day === 6) return false;
      if (h >= OPEN_HOUR && h < CLOSE_HOUR) return true;
      return false;
    }
    function getStatus(n) {
      if (n <= 0) return "free";
      if (n <= 1) return "normal";
      return "busy";
    }

    let lastStatus = null; 
    let lastDataTimestamp = 0; 
    let currentTrendMessage = ""; 

    function triggerNotification() {
      pseudoNotify.classList.add("show");
      setTimeout(() => { pseudoNotify.classList.remove("show"); }, 4000);
      if (!isIphone && "Notification" in window && Notification.permission === "granted") {
        new Notification("å­¦é£ŸãŒç©ºã„ã¦ãã¾ã—ãŸï¼", { body: "ä»Šãªã‚‰ä¸¦ã°ãšã«è¡Œã‘ãã†ã§ã™ ğŸ½", icon: "/favicon.ico" });
      }
    }

    function updateUI(people, timestamp) {
      lastDataTimestamp = timestamp * 1000;
      const date = new Date(lastDataTimestamp);
      const h = String(date.getHours()).padStart(2, '0');
      const m = String(date.getMinutes()).padStart(2, '0');
      lastUpdateTextEl.textContent = `æœ€çµ‚æ›´æ–°: ${date.getMonth()+1}/${date.getDate()} ${h}:${m}`;
      
      checkLiveStatus(); 

      if (!isBusinessOpen()) { showClosedUI(); return; }

      const now = Date.now();
      const diffMinutes = (now - lastDataTimestamp) / 1000 / 60;
      if (diffMinutes > DATA_TIMEOUT_MINUTES) { showStaleDataUI(); return; }

      countEl.textContent = people;
      waitTimeEl.textContent = people * MINUTES_PER_PERSON;
      renderVisualQueue(people);
      
      const current = getStatus(people);
      if (lastStatus !== "free" && current === "free") { triggerNotification(); }
      lastStatus = current;
      
      mainCard.className = "status-card";
      mainCard.classList.remove("free", "busy", "closed");
      if (current === "free") {
        statusTextEl.textContent = "ç©ºã„ã¦ã„ã¾ã™"; 
        mainCard.classList.add("free");
      } else if (current === "normal") {
        statusTextEl.textContent = "ãµã¤ã†";
      } else {
        statusTextEl.textContent = "æ··é›‘ä¸­"; 
        mainCard.classList.add("busy");
      }

      if (currentTrendMessage) {
        waitMessageEl.textContent = currentTrendMessage;
      } else {
        if (current === "free") waitMessageEl.textContent = "ä»ŠãŒãƒãƒ£ãƒ³ã‚¹ã§ã™ï¼";
        else if (current === "normal") waitMessageEl.textContent = "å°‘ã—ä¸¦ã¶ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“";
        else waitMessageEl.textContent = "æ™‚é–“ã«ä½™è£•ã‚’æŒã£ã¦è¡Œãã¾ã—ã‚‡ã†";
      }
    }

    function showClosedUI() {
        mainCard.className = "status-card closed";
        statusTextEl.textContent = "å–¶æ¥­æ™‚é–“å¤–"; waitMessageEl.textContent = "æœ¬æ—¥ã®å–¶æ¥­ã¯çµ‚äº†ã—ã¾ã—ãŸ";
        countEl.textContent = "--"; waitTimeEl.textContent = "--";
        visualQueueEl.innerHTML = '<span class="material-icons-round" style="font-size: 48px; color: #cbd5e1;">storefront</span>';
    }
    function showStaleDataUI() {
        mainCard.className = "status-card closed";
        statusTextEl.textContent = "ãƒ‡ãƒ¼ã‚¿å—ä¿¡å¾…ã¡"; waitMessageEl.textContent = "ã‚«ãƒ¡ãƒ©ã‚·ã‚¹ãƒ†ãƒ ãŒåœæ­¢ä¸­ã§ã™";
        countEl.textContent = "--"; waitTimeEl.textContent = "--";
        visualQueueEl.innerHTML = '<span class="material-icons-round" style="font-size: 48px; color: #cbd5e1;">cloud_off</span>';
    }
    function checkLiveStatus() {
      const now = Date.now();
      const diff = now - lastDataTimestamp;
      if (diff > 60000) {
        liveBadgeEl.className = "live-badge offline"; liveBadgeEl.innerHTML = '<span class="material-icons-round" style="font-size: 1rem;">cloud_off</span> OFFLINE';
      } else {
        liveBadgeEl.className = "live-badge online"; liveBadgeEl.innerHTML = '<div class="live-dot"></div> LIVE';
      }
      if (isBusinessOpen() && diff > DATA_TIMEOUT_MINUTES * 60 * 1000) { showStaleDataUI(); }
    }
    setInterval(checkLiveStatus, 5000);

    function renderVisualQueue(count) {
      visualQueueEl.innerHTML = "";
      const maxIcons = 10;
      const displayCount = Math.min(count, maxIcons);
      for(let i=0; i<displayCount; i++){
        const icon = document.createElement("span");
        icon.className = "material-icons-round person-icon";
        icon.textContent = "person";
        icon.style.animationDelay = `${i * 0.05}s`;
        visualQueueEl.appendChild(icon);
      }
      if(count > maxIcons) {
        const more = document.createElement("span");
        more.style.fontSize = "0.8rem"; more.style.color = "#999"; more.style.alignSelf = "center"; more.textContent = `+${count - maxIcons}`;
        visualQueueEl.appendChild(more);
      }
    }

    onValue(ref(db, "line_status"), snap => {
      const d = snap.val();
      if (!d) return;
      updateUI(d.people, d.timestamp);
      analyzeTrend(); 
    });

    /* ========= ã‚°ãƒ©ãƒ• & ãƒ‡ãƒ¼ã‚¿åˆ†æ ========= */
    const ctx = document.getElementById("lunchChart").getContext("2d");
    let chart;
    let allHistoryData = null;

    const currentLinePlugin = {
      id: 'currentLine',
      afterDatasetsDraw: (chart) => { // afterDatasetsDraw ã«å¤‰æ›´ã—ã¦ç¢ºå®Ÿã«æç”»
        const today = new Date();
        const todayDay = today.getDay();
        const selectedDay = parseInt(daySelector.value);
        if (todayDay !== selectedDay) return;

        const currentH = today.getHours();
        const currentM = today.getMinutes();

        if (currentH < 13 || currentH > 18) return;

        const ctx = chart.ctx;
        const xAxis = chart.scales.x;
        const yAxis = chart.scales.y;
        const { top, bottom } = chart.chartArea;

        const labelToFind = `${String(currentH).padStart(2, '0')}:${String(currentM).padStart(2, '0')}`;
        const x = xAxis.getPixelForValue(labelToFind);

        if (typeof x !== 'number' || isNaN(x)) return;

        ctx.save();
        ctx.beginPath();
        ctx.moveTo(x, top);
        ctx.lineTo(x, bottom);
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#ef4444';
        ctx.stroke();

        ctx.fillStyle = '#ef4444';
        ctx.textAlign = 'center';
        ctx.font = 'bold 10px Inter';
        ctx.fillText('NOW', x, top - 5);
        ctx.restore();
      }
    };

    function updateChart() {
      if (!allHistoryData) return;
      const selectedDay = parseInt(daySelector.value);
      
      const weekdayData = Object.values(allHistoryData).filter(v => new Date(v.timestamp * 1000).getDay() === selectedDay);
      
      if (chart) { chart.destroy(); chart = null; }

      const fixedLabels = [];
      for (let h = 13; h <= 18; h++) {
        for (let m = 0; m < 60; m++) {
           const timeLabel = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
           fixedLabels.push(timeLabel);
        }
      }

      if (weekdayData.length === 0) {
        noDataOverlay.classList.add("visible");
        return;
      }

      noDataOverlay.classList.remove("visible");

      const dates = weekdayData.map(v => new Date(v.timestamp * 1000).toDateString());
      const uniqueDates = [...new Set(dates)];
      const latestDateStr = uniqueDates[uniqueDates.length - 1]; 

      const historyBuckets = {};
      const currentBuckets = {};

      weekdayData.forEach(v => {
        const t = new Date(v.timestamp * 1000);
        const h = t.getHours();
        const m = t.getMinutes();
        if (h >= 13 && h <= 18) {
          const timeLabel = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
          if (!historyBuckets[timeLabel]) historyBuckets[timeLabel] = [];
          historyBuckets[timeLabel].push(v.people);
          if (t.toDateString() === latestDateStr) {
            if (!currentBuckets[timeLabel]) currentBuckets[timeLabel] = [];
            currentBuckets[timeLabel].push(v.people);
          }
        }
      });

      const avgValues = fixedLabels.map(time => {
        const counts = historyBuckets[time];
        if (!counts) return null;
        const sum = counts.reduce((a, b) => a + b, 0);
        return Math.round((sum / counts.length) * 10) / 10;
      });

      const currentValues = fixedLabels.map(time => {
        const counts = currentBuckets[time];
        if (!counts) return null;
        const sum = counts.reduce((a, b) => a + b, 0);
        return Math.round((sum / counts.length) * 10) / 10;
      });

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: fixedLabels,
          datasets: [
            { label: "ä»Šæ—¥", data: currentValues, borderColor: "#2563eb", backgroundColor: (context) => { const ctx = context.chart.ctx; const gradient = ctx.createLinearGradient(0, 0, 0, 200); gradient.addColorStop(0, "rgba(37,99,235,0.2)"); gradient.addColorStop(1, "rgba(37,99,235,0)"); return gradient; }, borderWidth: 2, pointRadius: 1, fill: true, tension: 0.4, order: 1, spanGaps: true },
            { label: "éå»å¹³å‡", data: avgValues, borderColor: "#94a3b8", borderDash: [5, 5], borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.4, order: 2, spanGaps: true }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: 'index' },
          scales: {
            x: { grid: { display: false }, ticks: { maxTicksLimit: 5, color: getComputedStyle(document.body).getPropertyValue('--text-sub').trim() } },
            y: { display: false, beginAtZero: true }
          },
          plugins: {
            legend: { display: true, labels: { boxWidth: 12, usePointStyle: true } },
            zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } }
          }
        },
        plugins: [currentLinePlugin]
      });
    }

    function analyzeTrend() {
      if (!allHistoryData || !countEl.textContent || isNaN(parseInt(countEl.textContent))) return;
      const currentPeople = parseInt(countEl.textContent);
      const now = new Date();
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      const day = now.getDay();
      const sameDayData = Object.values(allHistoryData).filter(v => {
        const d = new Date(v.timestamp * 1000);
        return d.getDay() === day && d.getHours() === currentHour && Math.abs(d.getMinutes() - currentMinute) <= 5; 
      });

      let avg = 0;
      if (sameDayData.length > 0) {
        const sum = sameDayData.reduce((a, b) => a + b.people, 0);
        avg = sum / sameDayData.length;
      }

      let message = "";
      if (avg > 0) {
        if (currentPeople < avg * 0.6) { message = "âœ¨ ã„ã¤ã‚‚ã‚ˆã‚Šã‹ãªã‚Šç©ºã„ã¦ã„ã¾ã™ï¼"; }
        else if (currentPeople > avg * 1.4) { message = "âš ï¸ ã„ã¤ã‚‚ã‚ˆã‚Šæ··é›‘ã—ã¦ã„ã¾ã™"; }
      }
      currentTrendMessage = message; 
      if (currentTrendMessage) waitMessageEl.textContent = currentTrendMessage;
    }

    daySelector.addEventListener("change", updateChart);
    onValue(ref(db, "line_history"), snap => {
      allHistoryData = snap.val();
      updateChart();
      analyzeTrend(); 
    });
  </script>
</body>
</html>