<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>å¿«é©é£Ÿå ‚ | Smart Restaurant</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb">
  <link rel="apple-touch-icon" href="icon.png">

  <meta property="og:title" content="å¿«é©é£Ÿå ‚ | Smart Restaurant" />
  <meta property="og:description" content="å­¦é£Ÿã®æ··é›‘çŠ¶æ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¢ºèªï¼ç©ºã„ã¦ã„ã‚‹æ™‚é–“ã‚’ç‹™ã£ã¦è¡Œã“ã†ã€‚" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://traffic-restaurant.web.app/" />
  <meta property="og:image" content="https://traffic-restaurant.web.app/icon.png" />
  <meta name="twitter:card" content="summary" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <style>
    :root {
      --primary: #2563eb; --bg: #f8fafc; --surface: #ffffff; --surface-sub: #f1f5f9;
      --text: #1e293b; --text-sub: #64748b; --border: #e2e8f0;
      --accent-free: #10b981; --accent-busy: #ef4444;
      --card-shadow: 0 10px 40px -10px rgba(0,0,0,0.08); --fab-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    body.dark-mode {
      --primary: #60a5fa; --bg: #0f172a; --surface: #1e293b; --surface-sub: #334155;
      --text: #f1f5f9; --text-sub: #94a3b8; --border: #334155;
      --accent-free: #34d399; --accent-busy: #f87171;
      --card-shadow: 0 10px 40px -10px rgba(0,0,0,0.5); --fab-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: var(--bg); color: var(--text); -webkit-tap-highlight-color: transparent; padding-bottom: 100px; overscroll-behavior: none; transition: background-color 0.3s, color 0.3s; }
    canvas { touch-action: none; }
    .container { max-width: 480px; margin: 0 auto; padding: 20px; display: flex; flex-direction: column; gap: 24px; }

    header { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
    .brand { display: flex; align-items: center; gap: 10px; }
    .brand-icon { font-size: 2rem; color: var(--primary); }
    .brand-text { display: flex; flex-direction: column; line-height: 1.1; }
    .brand-main { font-size: 1.25rem; font-weight: 800; color: var(--text); }
    .brand-sub { font-size: 0.75rem; font-weight: 600; color: var(--text-sub); letter-spacing: 0.02em; }
    .header-controls { display: flex; align-items: center; gap: 12px; }
    .theme-toggle-btn { background: none; border: none; color: var(--text-sub); cursor: pointer; padding: 4px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s, color 0.2s; }
    .theme-toggle-btn:active { background: var(--surface-sub); }
    .theme-toggle-btn .material-icons-round { font-size: 1.5rem; }
    
    .live-badge { font-size: 0.7rem; padding: 6px 10px; border-radius: 99px; font-weight: 700; display: flex; align-items: center; gap: 6px; transition: all 0.3s ease; }
    .live-badge.online { background: rgba(239, 68, 68, 0.15); color: var(--accent-busy); }
    .live-badge.offline { background: var(--surface-sub); color: var(--text-sub); }
    .live-dot { width: 6px; height: 6px; background: currentColor; border-radius: 50%; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% {opacity: 1;} 50% {opacity: 0.4;} 100% {opacity: 1;} }

    .status-card { background: var(--surface); border-radius: 24px; padding: 32px 24px; text-align: center; box-shadow: var(--card-shadow); transition: all 0.3s ease; border: 1px solid transparent; }
    .status-text { font-size: 2rem; font-weight: 800; margin-bottom: 8px; letter-spacing: -0.02em; }
    .status-sub { color: var(--text-sub); font-size: 0.9rem; font-weight: 600; min-height: 1.4em; }
    .status-card.busy .status-text { color: var(--accent-busy); }
    .status-card.free .status-text { color: var(--accent-free); }
    .status-card.closed { background: var(--surface-sub); box-shadow: none; border: 1px solid var(--border); }
    .status-card.closed .status-text { color: var(--text-sub); }
    .status-card.closed .metric-val { color: var(--text-sub); opacity: 0.5; }
    .status-card.closed .person-icon { color: var(--border) !important; }

    .visual-queue { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin: 24px 0; min-height: 40px; }
    .person-icon { font-family: 'Material Icons Round'; font-size: 32px; color: var(--text-sub); opacity: 0; transform: scale(0.5); animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    .person-icon.active { color: var(--primary); }
    @keyframes popIn { to { opacity: 1; transform: scale(1); } }

    .metrics { display: flex; justify-content: space-around; margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border); }
    .metric-item { display: flex; flex-direction: column; gap: 4px; }
    .metric-val { font-size: 1.4rem; font-weight: 800; }
    .metric-label { font-size: 0.75rem; color: var(--text-sub); font-weight: 600; }
    .last-update { margin-top: 16px; font-size: 0.7rem; color: var(--text-sub); text-align: right; opacity: 0.8; }

    .graph-section { background: var(--surface); border-radius: 20px; padding: 20px; box-shadow: var(--card-shadow); }
    .graph-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .section-title { font-size: 0.9rem; font-weight: 700; margin: 0; color: var(--text-sub); }
    .day-select { background: var(--bg); border: 1px solid var(--border); padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; color: var(--text); font-weight: 600; cursor: pointer; outline: none; }
    .chart-container { position: relative; height: 180px; width: 100%; }
    .no-data-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--surface); opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 10; }
    .no-data-overlay.visible { opacity: 1; pointer-events: auto; }
    .no-data-text { color: var(--text-sub); font-size: 0.85rem; font-weight: 600; margin-top: 8px; }
    .no-data-icon { font-size: 48px; color: var(--border); }

    .fab-btn { position: fixed; right: 24px; background: var(--text); color: var(--bg); border-radius: 99px; font-weight: 700; box-shadow: var(--fab-shadow); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100; transition: transform 0.2s; }
    .fab-btn:active { transform: scale(0.95); }
    
    .share-fab { bottom: 90px; width: 56px; height: 56px; border-radius: 50%; }
    .share-fab .material-icons-round { font-size: 24px; }
    
    .feedback-fab { bottom: 156px; width: 56px; height: 56px; border-radius: 50%; }
    .feedback-fab .material-icons-round { font-size: 24px; }

    .menu-fab { bottom: 24px; padding: 16px 24px; gap: 8px; }

    .overlay-base { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s; display: flex; }
    .overlay-base.open { opacity: 1; pointer-events: auto; }
    #menuModal, #feedbackModal { justify-content: center; align-items: flex-end; }
    .menu-sheet { background: var(--bg); width: 100%; max-width: 500px; height: 85vh; border-radius: 24px 24px 0 0; padding: 24px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; border-top: 1px solid var(--border); }
    #menuModal.open .menu-sheet, #feedbackModal.open .menu-sheet { transform: translateY(0); }
    
    /* ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ  */
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 700; margin-bottom: 8px; color: var(--text-sub); }
    .form-select, .form-textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: var(--surface); color: var(--text); font-family: inherit; font-size: 1rem; resize: none; outline: none; transition: border-color 0.2s; }
    .form-select:focus, .form-textarea:focus { border-color: var(--primary); }
    .form-textarea { height: 120px; }
    .submit-btn { width: 100%; padding: 16px; background: var(--text); color: var(--bg); border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .close-btn { background: var(--surface-sub); color: var(--text); border: none; width: 36px; height: 36px; border-radius: 50%; display: grid; place-items: center; cursor: pointer; }
    .menu-viewer { flex: 1; background: var(--surface); border-radius: 16px; overflow-y: auto; padding: 10px; display: flex; justify-content: center; align-items: start; }
    .menu-viewer img { width: 100%; height: auto; display: block; }
    #notifyModal { justify-content: center; align-items: center; }
    .notify-dialog { background: var(--surface); width: 85%; max-width: 320px; padding: 24px; border-radius: 20px; text-align: center; box-shadow: var(--card-shadow); }
    .notify-dialog h2 { margin: 0 0 12px; font-size: 1.1rem; }
    .notify-dialog p { font-size: 0.9rem; color: var(--text-sub); margin-bottom: 20px; line-height: 1.5; }
    .btn-group { display: flex; gap: 12px; }
    .btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-weight: 700; font-size: 0.9rem; cursor: pointer; }
    .btn-primary { background: var(--text); color: var(--bg); }
    .btn-secondary { background: var(--surface-sub); color: var(--text); }
    .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150%); background: var(--surface); padding: 16px 24px; border-radius: 16px; box-shadow: var(--card-shadow); display: flex; align-items: center; gap: 12px; z-index: 1000; transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1); min-width: 280px; border: 1px solid var(--border); }
    .toast.show { transform: translateX(-50%) translateY(0); }
    .toast-icon { font-size: 1.5rem; }
    .toast-content div:first-child { font-weight: 700; font-size: 0.9rem; color: var(--text); }
    .toast-content div:last-child { font-size: 0.8rem; color: var(--text-sub); }

    /* â–¼â–¼â–¼ ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ‹¡å¤§ï¼†ãƒ‰ãƒ©ãƒƒã‚°ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆä¿®æ­£ç‰ˆï¼‰ â–¼â–¼â–¼ */
    .menu-viewer {
      flex: 1; /* è¦ªè¦ç´ ã„ã£ã±ã„ã«åºƒã’ã‚‹ */
      overflow: auto; 
      
      /* â˜…ã“ã“ãŒä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼flexã‚’ã‚„ã‚ã¦blockã«ã—ã¾ã™ */
      display: block; 
      text-align: center; /* é€šå¸¸æ™‚ã¯çœŸã‚“ä¸­ã«è¡¨ç¤º */
      
      /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éš ã™ */
      scrollbar-width: none; 
      -ms-overflow-style: none;
      
      cursor: grab;
      overscroll-behavior: contain; 
      touch-action: none; /* JSã§åˆ¶å¾¡ã™ã‚‹ãŸã‚ãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨™æº–å‹•ä½œã‚’ç„¡åŠ¹åŒ– */
      user-select: none;
      
      /* ç”»åƒã®ä¸Šä¸‹ã«ä½™ç™½ã‚’æŒãŸã›ã¦è¦‹ã‚„ã™ãã™ã‚‹ */
      padding: 20px; 
    }
    
    .menu-viewer::-webkit-scrollbar {
      display: none;
    }
    
    .menu-viewer:active {
      cursor: grabbing;
    }
    
    ./* â–¼â–¼â–¼ ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ‹¡å¤§ï¼†ãƒ‰ãƒ©ãƒƒã‚°ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆãƒ•ã‚£ãƒƒãƒˆæ„Ÿæ”¹å–„ç‰ˆï¼‰ â–¼â–¼â–¼ */
    .menu-viewer {
      flex: 1;
      overflow: auto;
      display: block; /* æ‹¡å¤§æ™‚ã®ã¯ã¿å‡ºã—å¯¾ç­– */
      text-align: center;
      
      /* â˜…ä¿®æ­£ç‚¹: ä½™ç™½ã¨èƒŒæ™¯ã‚’æ¶ˆã—ã¦ã€è¦ªã®ã‚·ãƒ¼ãƒˆã«é¦´æŸ“ã¾ã›ã‚‹ */
      padding: 0; 
      background: transparent; 
      
      scrollbar-width: none; 
      -ms-overflow-style: none;
      
      cursor: grab;
      overscroll-behavior: contain; 
      touch-action: none;
      user-select: none;
    }
    
    .menu-viewer::-webkit-scrollbar {
      display: none;
    }
    
    .menu-viewer:active {
      cursor: grabbing;
    }
    
    .menu-viewer img {
      width: 100%;
      height: auto;
      
      /* â˜…ä¿®æ­£ç‚¹: ç”»åƒã®è§’ã ã‘å°‘ã—ä¸¸ãã—ã¦ã€ä¸‹ã®ä½™ç™½ã‚’ç¢ºä¿ */
      border-radius:12px; 
      display: block; /* ç”»åƒã®ä¸‹ã«è¬ã®éš™é–“ãŒã§ãã‚‹ã®ã‚’é˜²ã */
      
      -webkit-user-drag: none;
      transform-origin: top center; 
    }

    /* æ‹¡å¤§ãƒ¢ãƒ¼ãƒ‰ */
    .menu-viewer img.zoomed {
      width: 300%;
      max-width: none;
      margin: 0 auto; 
    }
    
    /* ä¸Šã®ãƒ’ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ã®ä½™ç™½èª¿æ•´ */
    .menu-viewer p {
      margin: 10px 0; /* ä¸Šä¸‹ã«å°‘ã—ä½™ç™½ã‚’å…¥ã‚Œã‚‹ */
    }
    /* â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–² */
  </style>
</head>
<body>

  <div id="pseudoNotify" class="toast">
    <div class="toast-icon">âœ¨</div>
    <div class="toast-content">
      <div>ç©ºã„ã¦ãã¾ã—ãŸï¼</div>
      <div>ä»ŠãŒãƒãƒ£ãƒ³ã‚¹ã§ã™</div>
    </div>
  </div>

  <div id="notifyModal" class="overlay-base">
    <div class="notify-dialog">
      <h2>é€šçŸ¥ã‚’ã‚ªãƒ³ã«ã—ã¾ã™ã‹ï¼Ÿ</h2>
      <p>è¡Œåˆ—ãŒè§£æ¶ˆã•ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§<br>ãŠçŸ¥ã‚‰ã›ã‚’å—ã‘å–ã‚Œã¾ã™ã€‚</p>
      <div class="btn-group">
        <button class="btn btn-secondary" id="notifyNo">ã‚ã¨ã§</button>
        <button class="btn btn-primary" id="notifyYes">è¨±å¯ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <div class="container">
    <header>
      <div class="brand" onclick="window.location.reload()" style="cursor: pointer;">
        <span class="material-icons-round brand-icon">restaurant_menu</span>
        <div class="brand-text">
          <span class="brand-main">å¿«é©é£Ÿå ‚</span>
          <span class="brand-sub">Smart Restaurant</span>
        </div>
      </div>
      <div class="header-controls">
        <button id="themeToggle" class="theme-toggle-btn">
          <span class="material-icons-round">dark_mode</span>
        </button>
        <div id="liveBadge" class="live-badge offline">
          <span class="material-icons-round" style="font-size: 1rem;">cloud_off</span> OFFLINE
        </div>
      </div>
    </header>

    <div id="mainCard" class="status-card">
      <div id="statusText" class="status-text">èª­ã¿è¾¼ã¿ä¸­...</div>
      <div id="waitMessage" class="status-sub">å°‘ã€…ãŠå¾…ã¡ãã ã•ã„</div>

      <div id="visualQueue" class="visual-queue"></div>

      <div class="metrics">
        <div class="metric-item">
          <span class="metric-val"><span id="count">--</span><span style="font-size:0.9rem">äºº</span></span>
          <span class="metric-label">ç¾åœ¨ã®è¡Œåˆ—</span>
        </div>
        <div class="metric-item">
          <span class="metric-val">~<span id="waitTime">--</span><span style="font-size:0.9rem">åˆ†</span></span>
          <span class="metric-label">æ¨å®šå¾…ã¡æ™‚é–“</span>
        </div>
      </div>

      <div id="lastUpdateText" class="last-update">æœ€çµ‚æ›´æ–°: --/-- --:--</div>
    </div>

    <div class="graph-section">
      <div class="graph-header">
        <h2 class="section-title">æ··é›‘ã®å‚¾å‘ã‚°ãƒ©ãƒ• (13:00-18:00)</h2>
        <select id="daySelector" class="day-select">
          <option value="0">æ—¥æ›œæ—¥</option>
          <option value="1">æœˆæ›œæ—¥</option>
          <option value="2">ç«æ›œæ—¥</option>
          <option value="3">æ°´æ›œæ—¥</option>
          <option value="4">æœ¨æ›œæ—¥</option>
          <option value="5">é‡‘æ›œæ—¥</option>
          <option value="6">åœŸæ›œæ—¥</option>
        </select>
      </div>
      
      <div class="chart-container">
        <canvas id="lunchChart"></canvas>
        <div id="noDataOverlay" class="no-data-overlay">
          <span class="material-icons-round no-data-icon">show_chart</span>
          <div class="no-data-text">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      </div>
    </div>
  </div>

  <div class="feedback-fab fab-btn" id="feedbackBtn">
    <span class="material-icons-round">chat_bubble_outline</span>
  </div>

  <div class="share-fab fab-btn" id="shareBtn">
    <span class="material-icons-round">share</span>
  </div>

  <div class="menu-fab fab-btn" id="menuBtn">
    <span class="material-icons-round">menu_book</span>
    æœ¬æ—¥ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼
  </div>

  <div class="overlay-base" id="feedbackModal">
    <div class="menu-sheet" style="height: auto; max-height: 85vh;">
      <div class="modal-header">
        <h2 style="margin:0; font-size:1.1rem;">ã”æ„è¦‹ãƒ»ã”è¦æœ›</h2>
        <button class="close-btn" id="closeFeedback">
          <span class="material-icons-round">close</span>
        </button>
      </div>
      <div style="padding-bottom: 20px;">
        <div class="form-group">
          <label class="form-label">ç¨®é¡</label>
          <select id="fbCategory" class="form-select">
            <option value="food">ğŸ½ é£Ÿäº‹ã«ã¤ã„ã¦ï¼ˆå…·ä½“çš„ã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼åãªã©ï¼‰</option>
            <option value="service">ğŸ“± ã‚µãƒ¼ãƒ“ã‚¹ã«ã¤ã„ã¦ï¼ˆå¿«é©é£Ÿå ‚ï¼‰</option>
            <option value="other">ğŸ’¬ ãã®ä»–</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">å†…å®¹</label>
          <textarea id="fbMessage" class="form-textarea" placeholder="ã”è‡ªç”±ã«ãŠæ›¸ããã ã•ã„..."></textarea>
        </div>
        <button id="fbSubmit" class="submit-btn">
          é€ä¿¡ã™ã‚‹ <span class="material-icons-round">send</span>
        </button>
      </div>
    </div>
  </div>

  <div class="overlay-base" id="menuModal">
    <div class="menu-sheet">
      <div class="modal-header">
        <h2 style="margin:0; font-size:1.1rem;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨</h2>
        <button class="close-btn" id="closeMenu">
          <span class="material-icons-round">close</span>
        </button>
      </div>

      <div class="menu-viewer" id="menuContainer">
        

        <img 
          id="menuImage"
          draggable="false" src="menu_img.png" 
          alt="æœ¬æ—¥ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼" 
          onerror="this.style.display='none';this.parentElement.innerHTML='<p style=\'text-align:center;color:#888;margin-top:20px\'>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>'" 
        />
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    /* ========= è¨­å®š ========= */
    const firebaseConfig = {
      databaseURL: "https://traffic-restaurant-default-rtdb.firebaseio.com/"
    };
    const MINUTES_PER_PERSON = 0.3;
    const isIphone = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const OPEN_HOUR = 8; 
    const CLOSE_HOUR = 20;
    const DATA_TIMEOUT_MINUTES = 1; 

    // â–¼â–¼â–¼ ã“ã“ã«GASã®URLã‚’è²¼ã‚Šä»˜ã‘ã‚‹ â–¼â–¼â–¼
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxYAdVhS19brD2FfGizWH5jBCUXGSLFTfq60wvLCCxkjptYz7WUpQZ71ay2lFoTtEv16w/exec"; 
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* ========= DOM ========= */
    const countEl = document.getElementById("count");
    const waitTimeEl = document.getElementById("waitTime");
    const statusTextEl = document.getElementById("statusText");
    const waitMessageEl = document.getElementById("waitMessage");
    const visualQueueEl = document.getElementById("visualQueue");
    const mainCard = document.getElementById("mainCard");
    const daySelector = document.getElementById("daySelector");
    const liveBadgeEl = document.getElementById("liveBadge");
    const lastUpdateTextEl = document.getElementById("lastUpdateText");
    const themeToggle = document.getElementById("themeToggle");
    const noDataOverlay = document.getElementById("noDataOverlay");
    daySelector.value = new Date().getDay();
    const menuBtn = document.getElementById("menuBtn");
    const menuModal = document.getElementById("menuModal");
    const closeMenu = document.getElementById("closeMenu");
    const notifyModal = document.getElementById("notifyModal");
    const notifyYes = document.getElementById("notifyYes");
    const notifyNo = document.getElementById("notifyNo");
    const pseudoNotify = document.getElementById("pseudoNotify");
    const shareBtn = document.getElementById("shareBtn");

    const feedbackBtn = document.getElementById("feedbackBtn");
    const feedbackModal = document.getElementById("feedbackModal");
    const closeFeedback = document.getElementById("closeFeedback");
    const fbSubmit = document.getElementById("fbSubmit");
    const fbCategory = document.getElementById("fbCategory");
    const fbMessage = document.getElementById("fbMessage");

    /* ========= ãƒ†ãƒ¼ãƒ ========= */
    const themeIcon = themeToggle.querySelector(".material-icons-round");
    const savedTheme = localStorage.getItem("theme");
    const systemDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    if (savedTheme === "dark" || (!savedTheme && systemDark)) {
      document.body.classList.add("dark-mode");
      themeIcon.textContent = "light_mode";
    } else {
      document.body.classList.remove("dark-mode");
      themeIcon.textContent = "dark_mode";
    }
    themeToggle.onclick = () => {
      document.body.classList.toggle("dark-mode");
      const isDark = document.body.classList.contains("dark-mode");
      themeIcon.textContent = isDark ? "light_mode" : "dark_mode";
      localStorage.setItem("theme", isDark ? "dark" : "light");
      if(chart) {
        chart.options.scales.x.ticks.color = getComputedStyle(document.body).getPropertyValue('--text-sub').trim();
        chart.update();
      }
    };

    /* ========= ã‚¤ãƒ™ãƒ³ãƒˆ ========= */
    menuBtn.onclick = () => menuModal.classList.add("open");
    closeMenu.onclick = () => menuModal.classList.remove("open");
    /* â–¼â–¼â–¼ ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã«èª¤ã£ã¦é–‰ã˜ãªã„ã‚ˆã†ã«åˆ¤å®šã‚’å¼·åŒ– â–¼â–¼â–¼ */
    let isMenuBgDown = false;
    
    // 1. ãƒã‚¦ã‚¹ã‚’æŠ¼ã—ãŸå ´æ‰€ãŒã€ŒèƒŒæ™¯ã€ã‹ãƒã‚§ãƒƒã‚¯
    menuModal.addEventListener('mousedown', (e) => {
      isMenuBgDown = (e.target === menuModal);
    });

    // 2. ãƒã‚¦ã‚¹ã‚’é›¢ã—ãŸæ™‚ã€ã€ŒæŠ¼ã—ãŸã®ã‚‚é›¢ã—ãŸã®ã‚‚èƒŒæ™¯ã€ãªã‚‰é–‰ã˜ã‚‹
    menuModal.addEventListener('mouseup', (e) => {
      if (isMenuBgDown && e.target === menuModal) {
        menuModal.classList.remove("open");
      }
      isMenuBgDown = false; // ãƒªã‚»ãƒƒãƒˆ
    });
    
    // å¤ã„è¨­å®šã¯ç„¡åŠ¹åŒ–ï¼ˆå¿µã®ãŸã‚ï¼‰
    menuModal.onclick = null;
    /* â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–² */

    feedbackBtn.onclick = () => feedbackModal.classList.add("open");
    closeFeedback.onclick = () => feedbackModal.classList.remove("open");
    feedbackModal.onclick = (e) => { if(e.target === feedbackModal) feedbackModal.classList.remove("open"); };

    fbSubmit.onclick = async () => {
      const msg = fbMessage.value.trim();
      if (!msg) {
        alert("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }
      
      fbSubmit.disabled = true;
      fbSubmit.textContent = "é€ä¿¡ä¸­...";

      try {
        await push(ref(db, "feedbacks"), {
          category: fbCategory.value,
          message: msg,
          timestamp: Date.now(),
          userAgent: navigator.userAgent
        });

        if (GAS_URL && GAS_URL !== "ã“ã“ã«GASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’è²¼ã‚Šä»˜ã‘") {
          fetch(GAS_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ category: fbCategory.value, message: msg })
          }).catch(e => console.error("LINEé€šçŸ¥ã‚¨ãƒ©ãƒ¼:", e));
        }
        
        alert("ã”æ„è¦‹ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼é€ä¿¡ã—ã¾ã—ãŸã€‚");
        fbMessage.value = "";
        feedbackModal.classList.remove("open");
      } catch (e) {
        console.error(e);
        alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
      } finally {
        fbSubmit.disabled = false;
        fbSubmit.innerHTML = 'é€ä¿¡ã™ã‚‹ <span class="material-icons-round">send</span>';
      }
    };

    if (!isIphone && "Notification" in window) {
      if (Notification.permission === "default") { setTimeout(() => { notifyModal.classList.add("open"); }, 1000); }
      notifyYes.onclick = async () => { await Notification.requestPermission(); notifyModal.classList.remove("open"); };
      notifyNo.onclick = () => { notifyModal.classList.remove("open"); };
    }
    shareBtn.onclick = async () => {
      let shareText = "";
      if (mainCard.classList.contains("closed") || statusTextEl.textContent === "ãƒ‡ãƒ¼ã‚¿å—ä¿¡å¾…ã¡") {
         shareText = "å­¦é£Ÿã®æ··é›‘çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã‚ˆã†ï¼\n";
      } else {
         shareText = `ç¾åœ¨ã®æ··é›‘çŠ¶æ³: ${countEl.textContent}äººå¾…ã¡ (${statusTextEl.textContent})\n`;
      }
      const shareData = { title: 'å¿«é©é£Ÿå ‚', text: shareText, url: window.location.href };
      if (navigator.share) { try { await navigator.share(shareData); } catch (err) {} } 
      else { alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼å‹é”ã«å…±æœ‰ã—ã‚ˆã†ï¼"); navigator.clipboard.writeText(window.location.href); }
    };

    /* ========= ãƒ­ã‚¸ãƒƒã‚¯ ========= */
    function isBusinessOpen() {
      // â–¼â–¼â–¼ ãƒ†ã‚¹ãƒˆç”¨ã«å¼·åˆ¶çš„ã«ã€Œå–¶æ¥­ä¸­ã€ã«ã™ã‚‹ â–¼â–¼â–¼ã“ã‚Œã¯æ¶ˆã™ã‚„ã¤
      return true; 
      
      // å…ƒã®ã‚³ãƒ¼ãƒ‰ã¯ä¸€æ—¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼ˆã¾ãŸã¯å‰Šé™¤ï¼‰
      /*
      const now = new Date();
      const day = now.getDay();
      const h = now.getHours();
      if (day === 0 || day === 6) return false;
      if (h >= OPEN_HOUR && h < CLOSE_HOUR) return true;
      return false;
      */
    }
    function getStatus(n) {
      if (n <= 0) return "free";
      if (n <= 1) return "normal";
      return "busy";
    }

    let lastStatus = null; 
    let lastDataTimestamp = 0; 
    let currentTrendMessage = ""; 

    function triggerNotification() {
      pseudoNotify.classList.add("show");
      setTimeout(() => { pseudoNotify.classList.remove("show"); }, 4000);
      if (!isIphone && "Notification" in window && Notification.permission === "granted") {
        new Notification("å­¦é£ŸãŒç©ºã„ã¦ãã¾ã—ãŸï¼", { body: "ä»Šãªã‚‰ä¸¦ã°ãšã«è¡Œã‘ãã†ã§ã™ ğŸ½", icon: "/favicon.ico" });
      }
    }

    function updateUI(people, timestamp) {
      lastDataTimestamp = timestamp * 1000;
      const date = new Date(lastDataTimestamp);
      const h = String(date.getHours()).padStart(2, '0');
      const m = String(date.getMinutes()).padStart(2, '0');
      lastUpdateTextEl.textContent = `æœ€çµ‚æ›´æ–°: ${date.getMonth()+1}/${date.getDate()} ${h}:${m}`;
      
      checkLiveStatus(); 

      if (!isBusinessOpen()) { showClosedUI(); return; }

      const now = Date.now();
      const diffMinutes = (now - lastDataTimestamp) / 1000 / 60;
      if (diffMinutes > DATA_TIMEOUT_MINUTES) { showStaleDataUI(); return; }

      countEl.textContent = people;
      waitTimeEl.textContent = Math.ceil(people * MINUTES_PER_PERSON);
      renderVisualQueue(people);
      
      const current = getStatus(people);
      if (lastStatus !== "free" && current === "free") { triggerNotification(); }
      lastStatus = current;
      
      mainCard.className = "status-card";
      mainCard.classList.remove("free", "busy", "closed");
      if (current === "free") {
        statusTextEl.textContent = "ç©ºã„ã¦ã„ã¾ã™"; 
        mainCard.classList.add("free");
      } else if (current === "normal") {
        statusTextEl.textContent = "ãµã¤ã†";
      } else {
        statusTextEl.textContent = "æ··é›‘ä¸­"; 
        mainCard.classList.add("busy");
      }

      if (currentTrendMessage) {
        waitMessageEl.textContent = currentTrendMessage;
      } else {
        if (current === "free") waitMessageEl.textContent = "ä»ŠãŒãƒãƒ£ãƒ³ã‚¹ã§ã™ï¼";
        else if (current === "normal") waitMessageEl.textContent = "å°‘ã—ä¸¦ã¶ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“";
        else waitMessageEl.textContent = "æ™‚é–“ã«ä½™è£•ã‚’æŒã£ã¦è¡Œãã¾ã—ã‚‡ã†";
      }
    }

    function showClosedUI() {
        mainCard.className = "status-card closed";
        statusTextEl.textContent = "å–¶æ¥­æ™‚é–“å¤–"; waitMessageEl.textContent = "æœ¬æ—¥ã®å–¶æ¥­ã¯çµ‚äº†ã—ã¾ã—ãŸ";
        countEl.textContent = "--"; waitTimeEl.textContent = "--";
        visualQueueEl.innerHTML = '<span class="material-icons-round" style="font-size: 48px; color: #cbd5e1;">storefront</span>';
    }
    function showStaleDataUI() {
        mainCard.className = "status-card closed";
        statusTextEl.textContent = "ãƒ‡ãƒ¼ã‚¿å—ä¿¡å¾…ã¡"; waitMessageEl.textContent = "ã‚«ãƒ¡ãƒ©ã‚·ã‚¹ãƒ†ãƒ ãŒåœæ­¢ä¸­ã§ã™";
        countEl.textContent = "--"; waitTimeEl.textContent = "--";
        visualQueueEl.innerHTML = '<span class="material-icons-round" style="font-size: 48px; color: #cbd5e1;">cloud_off</span>';
    }
    function checkLiveStatus() {
      const now = Date.now();
      const diff = now - lastDataTimestamp;
      if (diff > 60000) {
        liveBadgeEl.className = "live-badge offline"; liveBadgeEl.innerHTML = '<span class="material-icons-round" style="font-size: 1rem;">cloud_off</span> OFFLINE';
      } else {
        liveBadgeEl.className = "live-badge online"; liveBadgeEl.innerHTML = '<div class="live-dot"></div> LIVE';
      }
      if (isBusinessOpen() && diff > DATA_TIMEOUT_MINUTES * 60 * 1000) { showStaleDataUI(); }
    }
    setInterval(checkLiveStatus, 5000);

    function renderVisualQueue(count) {
      visualQueueEl.innerHTML = "";
      const maxIcons = 10;
      const displayCount = Math.min(count, maxIcons);
      for(let i=0; i<displayCount; i++){
        const icon = document.createElement("span");
        icon.className = "material-icons-round person-icon";
        icon.textContent = "person";
        icon.style.animationDelay = `${i * 0.05}s`;
        visualQueueEl.appendChild(icon);
      }
      if(count > maxIcons) {
        const more = document.createElement("span");
        more.style.fontSize = "0.8rem"; more.style.color = "#999"; more.style.alignSelf = "center"; more.textContent = `+${count - maxIcons}`;
        visualQueueEl.appendChild(more);
      }
    }

    onValue(ref(db, "line_status"), snap => {
      const d = snap.val();
      if (!d) return;
      updateUI(d.people, d.timestamp);
      analyzeTrend(); 
    });

    /* ========= ã‚°ãƒ©ãƒ• & ãƒ‡ãƒ¼ã‚¿åˆ†æ ========= */
    const ctx = document.getElementById("lunchChart").getContext("2d");
    let chart;
    let allHistoryData = null;

    const currentLinePlugin = {
      id: 'currentLine',
      afterDatasetsDraw: (chart) => { 
        const today = new Date();
        const todayDay = today.getDay();
        const selectedDay = parseInt(daySelector.value);
        if (todayDay !== selectedDay) return;

        const currentH = today.getHours();
        const currentM = today.getMinutes();

        if (currentH < 13 || currentH > 18) return;

        const ctx = chart.ctx;
        const xAxis = chart.scales.x;
        const yAxis = chart.scales.y;
        const { top, bottom } = chart.chartArea;

        const labelToFind = `${String(currentH).padStart(2, '0')}:${String(currentM).padStart(2, '0')}`;
        const x = xAxis.getPixelForValue(labelToFind);

        if (typeof x !== 'number' || isNaN(x)) return;

        ctx.save();
        ctx.beginPath();
        ctx.moveTo(x, top);
        ctx.lineTo(x, bottom);
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#ef4444';
        ctx.stroke();

        ctx.fillStyle = '#ef4444';
        ctx.textAlign = 'center';
        ctx.font = 'bold 10px Inter';
        ctx.fillText('NOW', x, top - 5);
        ctx.restore();
      }
    };

/* ========= ã‚°ãƒ©ãƒ•æ›´æ–°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«2æœ¬ç‰ˆï¼šä»Šæ—¥ vs å¹³å‡ï¼‰ ========= */
    function updateChart() {
      if (!allHistoryData) return;
      
      const selectedDay = parseInt(daySelector.value);
      const today = new Date();
      
      // 1. ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆé’ï¼‰
      const todayData = Object.values(allHistoryData).filter(v => {
        const d = new Date(v.timestamp * 1000);
        return d.getDay() === selectedDay && isSameDate(d, today);
      });

      // 2. éå»ã®å¹³å‡ï¼ˆã‚°ãƒ¬ãƒ¼ç‚¹ç·šï¼‰â€»ã“ã‚Œã‚’é¸ã³ã¾ã—ãŸï¼
      const avgData = Object.values(allHistoryData).filter(v => {
        const d = new Date(v.timestamp * 1000);
        return d.getDay() === selectedDay; 
      });

      if (chart) { chart.destroy(); chart = null; }

      // æ™‚é–“è»¸ãƒ©ãƒ™ãƒ« (13:00 - 18:00)
      const fixedLabels = [];
      for (let h = 13; h <= 18; h++) {
        for (let m = 0; m < 60; m++) {
           fixedLabels.push(`${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`);
        }
      }

      // ãƒ‡ãƒ¼ã‚¿æ•´å½¢é–¢æ•°
      const getValues = (dataList) => {
        const buckets = {};
        dataList.forEach(v => {
          const t = new Date(v.timestamp * 1000);
          const h = t.getHours();
          const m = t.getMinutes();
          if (h >= 13 && h <= 18) {
             const key = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
             if (!buckets[key]) buckets[key] = [];
             buckets[key].push(v.people);
          }
        });
        return fixedLabels.map(time => {
          const counts = buckets[time];
          if (!counts) return null;
          const sum = counts.reduce((a, b) => a + b, 0);
          return Math.round((sum / counts.length) * 10) / 10;
        });
      };

      const currentValues = getValues(todayData);
      const avgValues = getValues(avgData);

      // æœªæ¥äºˆå ±ç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
      window.latestAvgValues = avgValues;
      window.timeLabels = fixedLabels;

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: fixedLabels,
          datasets: [
            // ä»Šæ—¥ï¼ˆé’ãƒ»å¡—ã‚Šã¤ã¶ã—ï¼‰- ãƒ¡ã‚¤ãƒ³
            { 
              label: "ä»Šæ—¥", 
              data: currentValues, 
              borderColor: "#2563eb", 
              backgroundColor: (context) => {
                const ctx = context.chart.ctx;
                const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                gradient.addColorStop(0, "rgba(37,99,235,0.2)");
                gradient.addColorStop(1, "rgba(37,99,235,0)");
                return gradient;
              },
              borderWidth: 2, 
              pointRadius: 3, 
              fill: true, 
              tension: 0.4 
            },
            // å¹³å‡ï¼ˆã‚°ãƒ¬ãƒ¼ãƒ»ç‚¹ç·šï¼‰- æ¯”è¼ƒç”¨
            { 
              label: "å¹³å‡", 
              data: avgValues, 
              borderColor: "#94a3b8",
              borderWidth: 1.5, 
              pointRadius: 1, // ã”è¦æœ›é€šã‚Šã€ç‚¹ç·šã®ä¸Šã«ä¸¸ã‚’è¡¨ç¤º
              pointBackgroundColor: "#94a3b8",
              fill: false, 
              tension: 0.4 
            }
          ]
        },
        options: {
          animation: true, // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³OFF
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: 'index' },
          scales: {
            x: { grid: { display: false }, ticks: { maxTicksLimit: 5, color: '#64748b' } },
            y: { display: false, beginAtZero: true }
          },
          plugins: {
            legend: { display: true },
            zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } }
          }
        },
        plugins: [currentLinePlugin]
      });
    }

    /* ========= æœªæ¥äºˆå ±ï¼†åˆ†æï¼ˆæœ€æ–°ç‰ˆï¼‰ ========= */
    function analyzeTrend() {
      if (!countEl.textContent || isNaN(parseInt(countEl.textContent))) return;
      
      const currentPeople = parseInt(countEl.textContent);
      const avgValues = window.latestAvgValues; // updateChartã§ä½œã£ãŸå¹³å‡ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã†
      const labels = window.timeLabels;

      if (!avgValues || !labels) return;

      // ç¾åœ¨æ™‚åˆ»ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¢ã™
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      const timeStr = `${h}:${m}`;
      const currentIndex = labels.indexOf(timeStr);

      let message = "";

      if (currentIndex !== -1) {
        // 1. ç¾åœ¨ã®æ··ã¿å…·åˆåˆ¤å®š
        const currentAvg = avgValues[currentIndex] || 0;
        
        if (currentAvg > 0) {
          if (currentPeople < currentAvg * 0.7) {
            message = "âœ¨ ä»Šã¯ã„ã¤ã‚‚ã‚ˆã‚Šç©ºã„ã¦ã¾ã™ï¼";
          } else if (currentPeople > currentAvg * 1.3) {
            message = "âš ï¸ ã„ã¤ã‚‚ã‚ˆã‚Šæ··ã‚“ã§ã¾ã™";
          }
        }

        // 2. æœªæ¥äºˆå ±ï¼ˆ15åˆ†å¾Œã‚’è¦‹ã‚‹ï¼‰
        const futureIndex = currentIndex + 15;
        if (futureIndex < avgValues.length) {
           const futureAvg = avgValues[futureIndex];
           const diff = futureAvg - currentAvg; // æœªæ¥ - ç¾åœ¨

           // å¹³å‡ãƒ‡ãƒ¼ã‚¿ä¸Šã§ã€Œ3äººä»¥ä¸Šå¤‰åŒ–ã™ã‚‹ã€ãªã‚‰äºˆå ±ã‚’å‡ºã™
           if (diff < -3) {
             message += " (ã‚ã¨15åˆ†ã§ç©ºãäºˆå ± ğŸ“‰)";
           } else if (diff > 3) {
             message += " (ã“ã‚Œã‹ã‚‰æ··ã¿ãã†ã§ã™ ğŸ“ˆ)";
           }
        }
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°æ›´æ–°
      if (message) {
        waitMessageEl.textContent = message;
        waitMessageEl.style.color = "#ef4444"; // ã¡ã‚‡ã£ã¨ç›®ç«‹ã¤è‰²ã«
        waitMessageEl.style.fontWeight = "bold";
      } else {
         // é€šå¸¸æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
         const status = getStatus(currentPeople);
         waitMessageEl.style.color = "";
         waitMessageEl.style.fontWeight = "";
         if (status === "free") waitMessageEl.textContent = "ä»ŠãŒãƒãƒ£ãƒ³ã‚¹ã§ã™ï¼";
         else if (status === "normal") waitMessageEl.textContent = "æ¨™æº–çš„ãªæ··é›‘å…·åˆã§ã™";
         else waitMessageEl.textContent = "æ™‚é–“ã«ä½™è£•ã‚’æŒã£ã¦è¡Œãã¾ã—ã‚‡ã†";
      }
    }
    // â–¼â–¼â–¼ ã“ã‚ŒãŒè¶³ã‚Šãªã‹ã£ãŸã®ã§è¿½åŠ ã—ã¦ãã ã•ã„ï¼ â–¼â–¼â–¼
    function isSameDate(d1, d2) {
      return d1.getFullYear() === d2.getFullYear() &&
             d1.getMonth() === d2.getMonth() &&
             d1.getDate() === d2.getDate();
    }
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    daySelector.addEventListener("change", updateChart);
    let lastChartUpdate = 0; // å‰å›ã®æ›´æ–°æ™‚é–“ã‚’è¨˜éŒ²ã™ã‚‹å¤‰æ•°

    onValue(ref(db, "line_history"), snap => {
      allHistoryData = snap.val();
      
      // â–¼â–¼â–¼ 60ç§’ï¼ˆ60000msï¼‰çµŒéã—ã¦ã„ãªã‘ã‚Œã°æ›´æ–°ã—ãªã„ â–¼â–¼â–¼
      const now = Date.now();
      if (now - lastChartUpdate > 60000) {
        updateChart();
        lastChartUpdate = now;
      }
      // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

      analyzeTrend(); 
    });

   /* ========= ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒã®ãƒ‰ãƒ©ãƒƒã‚°ï¼†ã‚ºãƒ¼ãƒ æ©Ÿèƒ½ï¼ˆã‚¿ãƒƒãƒ—ä½ç½®ã‚ºãƒ¼ãƒ ç‰ˆï¼‰ ========= */
    const slider = document.getElementById('menuContainer');
    const menuImg = document.getElementById('menuImage');
    let isDown = false;
    let startX, startY;
    let scrollLeft, scrollTop;
    let isDragging = false;

    // å…±é€šã®é–‹å§‹å‡¦ç†
    const startDrag = (e, pageX, pageY) => {
      // â˜…ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼ã€Œè§¦ã£ãŸã®ãŒç”»åƒ(menuImg)ã˜ã‚ƒãªã‹ã£ãŸã‚‰ã€ç„¡è¦–ã—ã¦çµ‚äº†
      if (e.target !== menuImg) return;

      isDown = true;
      isDragging = false;
      slider.classList.add('active');
      startX = pageX - slider.offsetLeft;
      startY = pageY - slider.offsetTop;
      scrollLeft = slider.scrollLeft;
      scrollTop = slider.scrollTop;
    };

    // å…±é€šã®çµ‚äº†å‡¦ç†ï¼ˆâ˜…ã“ã“ã‚’å¤§å¹…æ”¹é€ ã—ã¾ã—ãŸï¼ï¼‰
    const endDrag = (e, clientX, clientY) => {
      isDown = false;
      slider.classList.remove('active');
      
      // ãƒ‰ãƒ©ãƒƒã‚°ã˜ã‚ƒãªã‹ã£ãŸï¼ˆãŸã ã®ã‚¿ãƒƒãƒ—ï¼‰å ´åˆ
      if (!isDragging) {
        const rect = menuImg.getBoundingClientRect();
        
        // ç”»åƒä¸Šã®ã©ã“ã‚’ã‚¿ãƒƒãƒ—ã—ãŸã‹è¨ˆç®—ï¼ˆ0.0 ã€œ 1.0 ã®å‰²åˆï¼‰
        // clientX/Y ãŒæ¸¡ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰å–å¾—
        const x = clientX || (e.changedTouches ? e.changedTouches[0].clientX : e.clientX);
        const y = clientY || (e.changedTouches ? e.changedTouches[0].clientY : e.clientY);
        
        const tapXRatio = (x - rect.left) / rect.width;
        const tapYRatio = (y - rect.top) / rect.height;

        // ã‚¯ãƒ©ã‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆï¼ˆã“ã“ã§å¤§ãã•ãŒå¤‰ã‚ã‚‹ï¼‰
        menuImg.classList.toggle('zoomed');

        // æ‹¡å¤§ãƒ¢ãƒ¼ãƒ‰ã«ãªã£ãŸç¬é–“ã€ã‚¿ãƒƒãƒ—ã—ãŸä½ç½®ãŒä¸­å¿ƒã«æ¥ã‚‹ã‚ˆã†ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼
        if (menuImg.classList.contains('zoomed')) {
          // æ‹¡å¤§å¾Œã®ç”»åƒã‚µã‚¤ã‚ºï¼ˆä»Šã®å¹… Ã— 2.5å€ ã¨ä»®å®šï¼‰
          // â€»CSSã§ .zoomed { width: 250% } ã«ãªã£ã¦ã„ã‚‹ã®ã§ 2.5 ã‚’æ›ã‘ã‚‹è¨ˆç®—ã§ã‚‚OKã§ã™ãŒã€
          //   ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ scrollWidth ã‚’ä½¿ã„ã¾ã™ã€‚
          
          // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¾…ã¡ã‚’é˜²ããŸã‚ã€å¼·åˆ¶çš„ã«å°‘ã—è¨ˆç®—ã•ã›ã‚‹ï¼ˆãŠã¾ã˜ãªã„ï¼‰
          const newWidth = slider.scrollWidth;
          const newHeight = slider.scrollHeight;

          // æ–°ã—ã„ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½® = (ç”»åƒã®æ–°ã—ã„å¹… * ã‚¿ãƒƒãƒ—ä½ç½®ã®å‰²åˆ) - (ç”»é¢ã®åŠåˆ†ã®å¹…)
          const targetX = (newWidth * tapXRatio) - (slider.clientWidth / 2);
          const targetY = (newHeight * tapYRatio) - (slider.clientHeight / 2);

          slider.scrollLeft = targetX;
          slider.scrollTop = targetY;
        }
      }
    };

    // å…±é€šã®ç§»å‹•å‡¦ç†
    const moveDrag = (e, pageX, pageY) => {
      if (!isDown) return;
      e.preventDefault(); 
      
      const x = pageX - slider.offsetLeft;
      const y = pageY - slider.offsetTop;
      
      if (Math.abs(x - startX) > 5 || Math.abs(y - startY) > 5) {
        isDragging = true;
      }

      slider.scrollLeft = scrollLeft - (x - startX) * 1.5;
      slider.scrollTop = scrollTop - (y - startY) * 1.5;
    };
    // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
    // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
    slider.addEventListener('mousedown', (e) => {
      e.preventDefault(); // â˜…PCã§ã®ç”»åƒé¸æŠã‚„ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã‚’å®Œå…¨ã«ç„¡åŠ¹åŒ–
      startDrag(e, e.pageX, e.pageY);
    });
    slider.addEventListener('mouseleave', () => { isDown = false; slider.classList.remove('active'); });
    slider.addEventListener('mouseup', (e) => endDrag(e, e.clientX, e.clientY));
    slider.addEventListener('mousemove', (e) => moveDrag(e, e.pageX, e.pageY));

    // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
    slider.addEventListener('touchstart', (e) => startDrag(e, e.touches[0].pageX, e.touches[0].pageY));
    
    slider.addEventListener('touchend', (e) => {
      if (e.cancelable) e.preventDefault();
      endDrag(e, e.changedTouches[0].clientX, e.changedTouches[0].clientY);
    });
    slider.addEventListener('touchmove', (e) => moveDrag(e, e.touches[0].pageX, e.touches[0].pageY));
  </script>
</body>
</html>